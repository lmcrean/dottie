name: Deploy to Vercel via CLI

# ğŸš€ VERCEL CLI APPROACH - HANDLES MONOREPOS PERFECTLY!
# =====================================================
# This workflow uses Vercel CLI with proper directory handling for monorepos.
# Works for backend/ and frontend/ subdirectories automatically!
# 
# ğŸ”§ SETUP REQUIRED:
# 1. Add Vercel tokens as Repository Secrets:
#    - Go to GitHub repo â†’ Settings â†’ Secrets and Variables â†’ Actions â†’ Secrets tab
#    - Add: VERCEL_TOKEN = your Vercel API token (from vercel.com/account/tokens)
#    - Add: VERCEL_ORG_ID = your Vercel team/org ID 
#    - Add: VERCEL_PROJECT_ID_BACKEND = backend project ID
#    - Add: VERCEL_PROJECT_ID_FRONTEND = frontend project ID
#
# 2. Get Project IDs:
#    - Run `npx vercel link` in backend/ and frontend/ directories
#    - Copy project IDs from .vercel/project.json files
#
# ğŸŒŸ BENEFITS:
# âœ… Handles monorepo structure perfectly
# âœ… Deploys from correct subdirectories (backend/, frontend/)  
# âœ… Full control over build process
# âœ… Works with any project structure
# âœ… Proper dependency handling

on:
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch: # Allow manual triggering

permissions:
  contents: read
  pull-requests: write

jobs:
  deploy-vercel:
    runs-on: ubuntu-latest
    outputs:
      backend-url: ${{ steps.backend-deploy.outputs.deployment-url }}
      frontend-url: ${{ steps.frontend-deploy.outputs.deployment-url }}
      deployment-status: ${{ steps.check-setup.outputs.deployment-status }}
    
    steps:
      - name: ğŸ›’ Checkout Repository
        uses: actions/checkout@v4
      
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: |
            backend/package-lock.json
            frontend/package-lock.json
      
      - name: ğŸ” Check Vercel Configuration
        id: check-setup
        run: |
          echo "Checking Vercel configuration..."
          
          # Check for required secrets
          has_token="${{ secrets.VERCEL_TOKEN != '' }}"
          has_org="${{ secrets.VERCEL_ORG_ID != '' }}"
          has_backend_project="${{ secrets.VERCEL_PROJECT_ID_BACKEND != '' }}"
          has_frontend_project="${{ secrets.VERCEL_PROJECT_ID_FRONTEND != '' }}"
          
          echo "ğŸ“Š Configuration status:"
          echo "Vercel Token: ${{ secrets.VERCEL_TOKEN != '' && 'âœ… Configured' || 'âŒ Missing' }}"
          echo "Org ID: ${{ secrets.VERCEL_ORG_ID != '' && 'âœ… Configured' || 'âŒ Missing' }}"
          echo "Backend Project ID: ${{ secrets.VERCEL_PROJECT_ID_BACKEND != '' && 'âœ… Configured' || 'âŒ Missing' }}"
          echo "Frontend Project ID: ${{ secrets.VERCEL_PROJECT_ID_FRONTEND != '' && 'âœ… Configured' || 'âŒ Missing' }}"
          
          if [[ "$has_token" == "true" && "$has_org" == "true" && "$has_backend_project" == "true" && "$has_frontend_project" == "true" ]]; then
            echo "deployment-status=ready" >> $GITHUB_OUTPUT
            echo "âœ… All configuration is present"
          else
            echo "deployment-status=missing-config" >> $GITHUB_OUTPUT
            echo "âŒ Missing required configuration"
          fi

      - name: ğŸ”§ Install Vercel CLI
        if: steps.check-setup.outputs.deployment-status == 'ready'
        run: npm install -g vercel@latest

      - name: ğŸš€ Deploy Backend to Vercel
        id: backend-deploy
        if: steps.check-setup.outputs.deployment-status == 'ready'
        working-directory: ./backend
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID_BACKEND }}
        run: |
          echo "ğŸ”¥ Deploying backend from backend/ directory..."
          
          # Deploy with Vercel CLI
          deployment_url=$(vercel deploy --token=$VERCEL_TOKEN --yes --force)
          
          if [ $? -eq 0 ] && [ -n "$deployment_url" ]; then
            echo "deployment-url=$deployment_url" >> $GITHUB_OUTPUT
            echo "âœ… Backend deployment successful!"
            echo "ğŸ“ Backend URL: $deployment_url"
          else
            echo "âŒ Backend deployment failed"
            exit 1
          fi

      - name: ğŸŒ Deploy Frontend to Vercel  
        id: frontend-deploy
        if: steps.check-setup.outputs.deployment-status == 'ready'
        working-directory: ./frontend
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID_FRONTEND }}
        run: |
          echo "ğŸ”¥ Deploying frontend from frontend/ directory..."
          
          # Add small delay to ensure backend is ready
          echo "â³ Waiting 10 seconds for backend to be ready..."
          sleep 10
          
          # Deploy with Vercel CLI
          deployment_url=$(vercel deploy --token=$VERCEL_TOKEN --yes --force)
          
          if [ $? -eq 0 ] && [ -n "$deployment_url" ]; then
            echo "deployment-url=$deployment_url" >> $GITHUB_OUTPUT
            echo "âœ… Frontend deployment successful!"
            echo "ğŸ“ Frontend URL: $deployment_url"
          else
            echo "âŒ Frontend deployment failed"
            exit 1
          fi

      - name: ğŸ’¬ Update PR with Deployment Status
        uses: actions/github-script@v7
        with:
          script: |
            const backendUrl = '${{ steps.backend-deploy.outputs.deployment-url }}';
            const frontendUrl = '${{ steps.frontend-deploy.outputs.deployment-url }}';
            const deploymentStatus = '${{ steps.check-setup.outputs.deployment-status }}';
            
            let commentBody = '';
            
            if (deploymentStatus === 'ready' && backendUrl && frontendUrl) {
              commentBody = `## ğŸš€ Vercel Deployments Successful!

              Your monorepo has been deployed successfully! ğŸ‰

              ### ğŸ”— Preview URLs
              - **ğŸ”§ Backend**: ${backendUrl}
              - **ğŸŒ Frontend**: ${frontendUrl}

              ### âœ¨ What Happened
              1. âœ… Backend deployed from \`backend/\` directory
              2. âœ… Frontend deployed from \`frontend/\` directory  
              3. âœ… Both deployments completed successfully

              ### ğŸ§ª Test Your Changes
              Click the URLs above to test your changes in the preview environment!

              ---
              âš¡ **Status**: Deployments complete and ready for testing!
              
              *ğŸ”„ Last updated: ${new Date().toLocaleString()} UTC*`;
              
            } else if (deploymentStatus === 'missing-config') {
              commentBody = `## ğŸ”§ Vercel CLI Not Set Up

              Vercel CLI deployments are not configured yet. This approach handles monorepos perfectly!

              ### ğŸ› ï¸ Setup Instructions for Maintainers

              #### 1. Get Vercel API Token
              - Go to [Vercel Account Settings](https://vercel.com/account/tokens)
              - Create a new token
              - Copy the token value

              #### 2. Get Organization ID
              \`\`\`bash
              npx vercel teams list
              # Copy your team/org ID
              \`\`\`

              #### 3. Get Project IDs
              \`\`\`bash
              # In backend directory
              cd backend && npx vercel link
              cat .vercel/project.json  # Copy projectId

              # In frontend directory  
              cd frontend && npx vercel link
              cat .vercel/project.json  # Copy projectId
              \`\`\`

              #### 4. Add GitHub Secrets
              Go to **Settings** â†’ **Secrets and Variables** â†’ **Actions** â†’ **Secrets**:
              - \`VERCEL_TOKEN\` = your API token
              - \`VERCEL_ORG_ID\` = your organization ID
              - \`VERCEL_PROJECT_ID_BACKEND\` = backend project ID
              - \`VERCEL_PROJECT_ID_FRONTEND\` = frontend project ID

              #### 5. Test the Setup
              - Push to this PR or create a new PR
              - Deployments will automatically work from correct directories! ğŸ‰

              ### ğŸ§ª Testing Changes Locally
              \`\`\`bash
              # Backend
              cd backend && npm install && npm run dev

              # Frontend (new terminal)
              cd frontend && npm install && npm run dev
              \`\`\`

              ### ğŸŒŸ Benefits of Vercel CLI
              - âœ… Perfect monorepo support (deploys from subdirectories)
              - âœ… Full control over build process
              - âœ… Works with any project structure
              - âœ… Handles dependencies correctly
              - âœ… Preview URLs for every PR`;
              
            } else {
              commentBody = `## âŒ Deployment Issues

              There was an issue with the Vercel CLI deployments. Please check the workflow logs for details.

              ### ğŸ”§ Troubleshooting
              - Verify all Vercel secrets are set correctly
              - Check project IDs match your Vercel projects
              - Ensure API token has correct permissions

              ### ğŸ§ª Test Locally
              \`\`\`bash
              # Backend
              cd backend && npm install && npm run dev

              # Frontend (new terminal)
              cd frontend && npm install && npm run dev
              \`\`\``;
            }

            commentBody += `
            
            <!-- VERCEL_CLI_COMMENT_MARKER -->`;

            // Find existing comment
            const comments = await github.rest.issues.listComments({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
            });

            const existingComment = comments.data.find(comment => 
              comment.body.includes('<!-- VERCEL_CLI_COMMENT_MARKER -->')
            );

            if (existingComment) {
              await github.rest.issues.updateComment({
                comment_id: existingComment.id,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: commentBody
              });
              console.log('âœ… Updated existing Vercel CLI comment');
            } else {
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: commentBody
              });
              console.log('âœ… Created new Vercel CLI comment');
            }

  workflow-summary:
    runs-on: ubuntu-latest
    needs: deploy-vercel
    if: always()
    
    steps:
      - name: ğŸ“Š Deployment Summary
        run: |
          echo "ğŸ” Vercel CLI Workflow Summary"
          echo "=============================="
          
          deployment_status="${{ needs.deploy-vercel.outputs.deployment-status }}"
          backend_url="${{ needs.deploy-vercel.outputs.backend-url }}"
          frontend_url="${{ needs.deploy-vercel.outputs.frontend-url }}"
          
          case "$deployment_status" in
            "ready")
              if [[ -n "$backend_url" && -n "$frontend_url" ]]; then
                echo "âœ… SUCCESS: Both deployments completed successfully"
                echo "ğŸ”§ Backend: $backend_url"
                echo "ğŸŒ Frontend: $frontend_url"
                echo ""
                echo "ğŸ‰ Your monorepo is deployed and ready for testing!"
              else
                echo "âš ï¸ PARTIAL: Some deployments may have failed"
                echo "Backend: ${backend_url:-âŒ Failed}"
                echo "Frontend: ${frontend_url:-âŒ Failed}"
              fi
              ;;
            "missing-config")
              echo "âŒ NOT CONFIGURED: Vercel CLI secrets not set up"
              echo ""
              echo "ğŸ› ï¸ Setup Required:"
              echo "1. Get Vercel API token and project IDs"
              echo "2. Add secrets to GitHub repository"
              echo "3. Re-run this workflow"
              ;;
            *)
              echo "â“ UNKNOWN: Unexpected deployment status"
              echo "Check workflow logs for details"
              ;;
          esac
          
          echo ""
          echo "ğŸŒŸ Vercel CLI Benefits:"
          echo "- Perfect monorepo support"
          echo "- Deploys from correct subdirectories (backend/, frontend/)"
          echo "- Full control over build process"
          echo "- Works with any project structure"
          
          # Create GitHub Actions Summary
          cat >> $GITHUB_STEP_SUMMARY << EOF
          ## ğŸš€ Vercel CLI Deployment Results
          
          **Status**: $deployment_status
          
          $(case "$deployment_status" in
            "ready")
              if [[ -n "$backend_url" && -n "$frontend_url" ]]; then
                echo "### âœ… Monorepo Deployed Successfully"
                echo "- **ğŸ”§ Backend**: [$backend_url]($backend_url)"
                echo "- **ğŸŒ Frontend**: [$frontend_url]($frontend_url)"
                echo ""
                echo "ğŸ‰ Both applications deployed from their respective directories!"
              else
                echo "### âš ï¸ Partial Deployment"
                echo "Some deployments may have failed. Check logs for details."
              fi
              ;;
            "missing-config")
              echo "### ğŸ”§ Setup Required"
              echo "Vercel CLI needs to be configured with API tokens and project IDs."
              ;;
            *)
              echo "### â“ Unknown Status"
              echo "Check workflow logs for details."
              ;;
          esac)
          
          ---
          
          ### ğŸ—ï¸ About Vercel CLI
          This workflow uses the [Vercel CLI](https://vercel.com/docs/cli) to deploy directly from subdirectories, perfect for monorepos like yours with \`backend/\` and \`frontend/\` folders.
          
          EOF 