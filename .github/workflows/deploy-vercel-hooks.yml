name: Deploy to Vercel via Deploy Hooks

# ğŸš€ DEPLOY HOOKS APPROACH - WORKS FOR ALL CONTRIBUTORS!
# ======================================================
# This workflow uses Vercel Deploy Hooks - simple HTTP POST requests that require no authentication.
# Perfect for open source projects as it works for both maintainers and external contributors!
# 
# ğŸ”§ SETUP REQUIRED:
# 1. Create Deploy Hooks in Vercel Dashboard:
#    - Go to each project â†’ Settings â†’ Git â†’ Deploy Hooks
#    - Create hook for the branch you want to deploy (main, or specific branches)
#    - Copy the generated URLs
#
# 2. Add Deploy Hook URLs as Repository Variables (NOT secrets):
#    - Go to GitHub repo â†’ Settings â†’ Secrets and Variables â†’ Actions â†’ Variables tab
#    - Add: VERCEL_BACKEND_DEPLOY_HOOK = https://api.vercel.com/v1/integrations/deploy/prj_xxx/hookId
#    - Add: VERCEL_FRONTEND_DEPLOY_HOOK = https://api.vercel.com/v1/integrations/deploy/prj_yyy/hookId
#
# 3. Optional: Set up branch-specific hooks for preview deployments
#
# ğŸŒŸ BENEFITS:
# âœ… Works for external contributors (no authentication needed)
# âœ… No complex Vercel CLI setup
# âœ… No workflow failures due to missing secrets  
# âœ… Simple HTTP requests that always work
# âœ… Automatic deployments for every PR
# âœ… Same experience for everyone

on:
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch: # Allow manual triggering

permissions:
  contents: read
  pull-requests: write

jobs:
  deploy-via-hooks:
    runs-on: ubuntu-latest
    outputs:
      backend-job-id: ${{ steps.backend-deploy.outputs.job-id }}
      frontend-job-id: ${{ steps.frontend-deploy.outputs.job-id }}
      deployment-triggered: ${{ steps.check-hooks.outputs.deployment-triggered }}
    
    steps:
      - name: ğŸ” Check Deploy Hook Configuration
        id: check-hooks
        run: |
          echo "Checking Deploy Hook configuration..."
          
          backend_hook="${{ vars.VERCEL_BACKEND_DEPLOY_HOOK }}"
          frontend_hook="${{ vars.VERCEL_FRONTEND_DEPLOY_HOOK }}"
          
          if [ -n "$backend_hook" ] && [ -n "$frontend_hook" ]; then
            echo "âœ… Both Deploy Hooks are configured"
            echo "deployment-triggered=true" >> $GITHUB_OUTPUT
          elif [ -n "$backend_hook" ] || [ -n "$frontend_hook" ]; then
            echo "âš ï¸ Only one Deploy Hook is configured"
            echo "deployment-triggered=partial" >> $GITHUB_OUTPUT
          else
            echo "âŒ No Deploy Hooks configured"
            echo "deployment-triggered=false" >> $GITHUB_OUTPUT
          fi
          
          echo "ğŸ“Š Configuration status:"
          echo "Backend Hook: ${{ vars.VERCEL_BACKEND_DEPLOY_HOOK != '' && 'âœ… Configured' || 'âŒ Missing' }}"
          echo "Frontend Hook: ${{ vars.VERCEL_FRONTEND_DEPLOY_HOOK != '' && 'âœ… Configured' || 'âŒ Missing' }}"

      - name: ğŸš€ Deploy Backend via Hook
        id: backend-deploy
        if: vars.VERCEL_BACKEND_DEPLOY_HOOK != ''
        run: |
          echo "ğŸ”¥ Triggering backend deployment..."
          echo "Hook URL: ${{ vars.VERCEL_BACKEND_DEPLOY_HOOK }}"
          
          # Trigger deployment with error handling
          response=$(curl -s -w "\n%{http_code}" -X POST "${{ vars.VERCEL_BACKEND_DEPLOY_HOOK }}" \
            -H "Content-Type: application/json" \
            -H "User-Agent: GitHub-Actions-Deploy-Hook") || {
            echo "âŒ Failed to trigger backend deployment"
            exit 1
          }
          
          # Split response and status code
          http_code=$(echo "$response" | tail -n1)
          json_response=$(echo "$response" | head -n -1)
          
          echo "HTTP Status: $http_code"
          echo "Response: $json_response"
          
          if [ "$http_code" = "200" ] || [ "$http_code" = "201" ]; then
            # Extract job ID from response
            job_id=$(echo "$json_response" | grep -o '"id":"[^"]*"' | cut -d'"' -f4 | head -1)
            if [ -n "$job_id" ]; then
              echo "job-id=$job_id" >> $GITHUB_OUTPUT
              echo "âœ… Backend deployment triggered successfully!"
              echo "ğŸ“ Job ID: $job_id"
            else
              echo "âš ï¸ Deployment triggered but couldn't extract job ID"
              echo "job-id=unknown" >> $GITHUB_OUTPUT
            fi
          else
            echo "âŒ Backend deployment failed with HTTP $http_code"
            echo "Response: $json_response"
            exit 1
          fi

      - name: ğŸŒ Deploy Frontend via Hook
        id: frontend-deploy
        if: vars.VERCEL_FRONTEND_DEPLOY_HOOK != ''
        run: |
          echo "ğŸ”¥ Triggering frontend deployment..."
          echo "Hook URL: ${{ vars.VERCEL_FRONTEND_DEPLOY_HOOK }}"
          
          # Add small delay to ensure backend starts first
          echo "â³ Waiting 5 seconds for backend to start..."
          sleep 5
          
          # Trigger deployment with error handling
          response=$(curl -s -w "\n%{http_code}" -X POST "${{ vars.VERCEL_FRONTEND_DEPLOY_HOOK }}" \
            -H "Content-Type: application/json" \
            -H "User-Agent: GitHub-Actions-Deploy-Hook") || {
            echo "âŒ Failed to trigger frontend deployment"
            exit 1
          }
          
          # Split response and status code
          http_code=$(echo "$response" | tail -n1)
          json_response=$(echo "$response" | head -n -1)
          
          echo "HTTP Status: $http_code"
          echo "Response: $json_response"
          
          if [ "$http_code" = "200" ] || [ "$http_code" = "201" ]; then
            # Extract job ID from response
            job_id=$(echo "$json_response" | grep -o '"id":"[^"]*"' | cut -d'"' -f4 | head -1)
            if [ -n "$job_id" ]; then
              echo "job-id=$job_id" >> $GITHUB_OUTPUT
              echo "âœ… Frontend deployment triggered successfully!"
              echo "ğŸ“ Job ID: $job_id"
            else
              echo "âš ï¸ Deployment triggered but couldn't extract job ID"
              echo "job-id=unknown" >> $GITHUB_OUTPUT
            fi
          else
            echo "âŒ Frontend deployment failed with HTTP $http_code"
            echo "Response: $json_response"
            exit 1
          fi

      - name: ğŸ’¬ Update PR with Deployment Status
        uses: actions/github-script@v7
        with:
          script: |
            const backendJobId = '${{ steps.backend-deploy.outputs.job-id }}';
            const frontendJobId = '${{ steps.frontend-deploy.outputs.job-id }}';
            const deploymentTriggered = '${{ steps.check-hooks.outputs.deployment-triggered }}';
            
            let commentBody = '';
            
            if (deploymentTriggered === 'true' && backendJobId && frontendJobId) {
              commentBody = `## ğŸš€ Deployments Triggered Successfully!

              Your changes are being deployed to Vercel via Deploy Hooks! ğŸ‰

              ### ğŸ“Š Deployment Jobs
              - **ğŸ”§ Backend**: Job \`${backendJobId}\` 
              - **ğŸŒ Frontend**: Job \`${frontendJobId}\`

              ### ğŸ” Monitor Progress
              - Check [Vercel Dashboard](https://vercel.com/dashboard) for real-time status
              - Deployments typically complete in 1-3 minutes
              - Preview URLs will appear in Vercel dashboard once ready

              ### âœ¨ What's Happening
              1. Backend deployment started first
              2. Frontend deployment triggered (with backend integration)
              3. Both will be available at preview URLs when complete

              ---
              â³ **Status**: Deployments in progress... Check Vercel dashboard for preview URLs!
              
              *ğŸ”„ Last updated: ${new Date().toLocaleString()} UTC*`;
              
            } else if (deploymentTriggered === 'partial') {
              const activeDeployment = backendJobId ? 'Backend' : 'Frontend';
              const activeJobId = backendJobId || frontendJobId;
              
              commentBody = `## âš ï¸ Partial Deployment Triggered

              Only **${activeDeployment}** deployment was triggered successfully.

              ### ğŸ“Š Active Deployment
              - **${activeDeployment}**: Job \`${activeJobId}\`

              ### ğŸ”§ Action Required
              The other deployment hook appears to be missing or misconfigured. 
              Please check repository variables:
              - \`VERCEL_BACKEND_DEPLOY_HOOK\`
              - \`VERCEL_FRONTEND_DEPLOY_HOOK\`

              ### ğŸ§ª Test Locally Meanwhile
              \`\`\`bash
              # Backend
              cd backend && npm install && npm run dev

              # Frontend (new terminal)  
              cd frontend && npm install && npm run dev
              \`\`\``;
              
            } else if (deploymentTriggered === 'false') {
              commentBody = `## ğŸ”§ Deploy Hooks Not Set Up

              No Deploy Hook deployments were triggered because the hooks haven't been configured yet.

              ### ğŸ› ï¸ Setup Instructions for Maintainers

              #### 1. Create Deploy Hooks in Vercel
              For **each project** (backend & frontend):
              - Go to Vercel Dashboard â†’ Project â†’ Settings â†’ Git
              - Scroll to "Deploy Hooks" section  
              - Click "Create Hook"
              - Name: \`GitHub-PR-Previews\` (or similar)
              - Branch: \`main\` (or your default branch)
              - Copy the generated URL

              #### 2. Add URLs as Repository Variables
              - Go to GitHub repo â†’ Settings â†’ Secrets and Variables â†’ Actions
              - Click **Variables** tab (not Secrets!)
              - Add these variables:
                - \`VERCEL_BACKEND_DEPLOY_HOOK\` = your backend hook URL
                - \`VERCEL_FRONTEND_DEPLOY_HOOK\` = your frontend hook URL

              #### 3. Test the Setup
              - Create a new PR or push to this PR
              - The workflow will automatically trigger deployments! ğŸ‰

              ### ğŸ§ª Testing Changes Locally
              \`\`\`bash
              # Backend
              cd backend && npm install && npm run dev

              # Frontend (new terminal)
              cd frontend && npm install && npm run dev
              \`\`\`

              ### ğŸŒŸ Benefits of Deploy Hooks
              - âœ… Works for **all contributors** (no authentication issues)
              - âœ… Simple HTTP requests (no complex CLI setup)
              - âœ… Automatic deployments for every PR
              - âœ… No workflow failures due to missing secrets`;
              
            } else {
              commentBody = `## âŒ Deployment Issues

              There was an issue triggering the deployments. Please check the workflow logs for details.

              ### ğŸ”§ Troubleshooting
              - Verify Deploy Hook URLs are correct
              - Check Vercel project settings
              - Ensure hooks are for the correct branch

              ### ğŸ§ª Test Locally
              \`\`\`bash
              # Backend
              cd backend && npm install && npm run dev

              # Frontend (new terminal)
              cd frontend && npm install && npm run dev
              \`\`\``;
            }

            commentBody += `
            
            <!-- DEPLOY_HOOKS_COMMENT_MARKER -->`;

            // Find existing comment
            const comments = await github.rest.issues.listComments({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
            });

            const existingComment = comments.data.find(comment => 
              comment.body.includes('<!-- DEPLOY_HOOKS_COMMENT_MARKER -->')
            );

            if (existingComment) {
              await github.rest.issues.updateComment({
                comment_id: existingComment.id,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: commentBody
              });
              console.log('âœ… Updated existing Deploy Hooks comment');
            } else {
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: commentBody
              });
              console.log('âœ… Created new Deploy Hooks comment');
            }

  workflow-summary:
    runs-on: ubuntu-latest
    needs: deploy-via-hooks
    if: always()
    
    steps:
      - name: ğŸ“Š Deployment Summary
        run: |
          echo "ğŸ” Deploy Hooks Workflow Summary"
          echo "================================"
          
          deployment_status="${{ needs.deploy-via-hooks.outputs.deployment-triggered }}"
          backend_job="${{ needs.deploy-via-hooks.outputs.backend-job-id }}"
          frontend_job="${{ needs.deploy-via-hooks.outputs.frontend-job-id }}"
          
          case "$deployment_status" in
            "true")
              echo "âœ… SUCCESS: Both deployments triggered successfully"
              echo "ğŸ”§ Backend Job: $backend_job"
              echo "ğŸŒ Frontend Job: $frontend_job"
              echo ""
              echo "ğŸ” Next Steps:"
              echo "- Monitor progress in Vercel Dashboard"
              echo "- Preview URLs will be available when deployments complete"
              ;;
            "partial")
              echo "âš ï¸ PARTIAL: Only one deployment was triggered"
              echo "Active Job: ${backend_job:-$frontend_job}"
              echo ""
              echo "ğŸ”§ Action Required:"
              echo "- Check Deploy Hook configuration"
              echo "- Ensure both VERCEL_BACKEND_DEPLOY_HOOK and VERCEL_FRONTEND_DEPLOY_HOOK are set"
              ;;
            "false")
              echo "âŒ NOT CONFIGURED: No Deploy Hooks set up"
              echo ""
              echo "ğŸ› ï¸ Setup Required:"
              echo "1. Create Deploy Hooks in Vercel Dashboard"
              echo "2. Add hook URLs as repository variables"
              echo "3. Re-run this workflow"
              ;;
            *)
              echo "â“ UNKNOWN: Unexpected deployment status"
              echo "Check workflow logs for details"
              ;;
          esac
          
          echo ""
          echo "ğŸŒŸ Deploy Hooks Benefits:"
          echo "- Works for ALL contributors (maintainers + external)"
          echo "- No authentication required"
          echo "- Simple HTTP requests"
          echo "- Automatic deployments"
          echo "- No complex CLI setup"
          
          # Create GitHub Actions Summary
          cat >> $GITHUB_STEP_SUMMARY << EOF
          ## ğŸš€ Deploy Hooks Workflow Results
          
          **Deployment Status**: $deployment_status
          
          $(case "$deployment_status" in
            "true")
              echo "### âœ… Both Deployments Triggered"
              echo "- **Backend Job**: \`$backend_job\`"
              echo "- **Frontend Job**: \`$frontend_job\`"
              echo ""
              echo "Monitor progress in [Vercel Dashboard](https://vercel.com/dashboard)"
              ;;
            "partial")
              echo "### âš ï¸ Partial Deployment"
              echo "Only one deployment was triggered. Check Deploy Hook configuration."
              ;;
            "false")
              echo "### ğŸ”§ Setup Required"
              echo "Deploy Hooks need to be configured. See PR comment for instructions."
              ;;
            *)
              echo "### â“ Unknown Status"
              echo "Check workflow logs for details."
              ;;
          esac)
          
          ---
          
          ### ğŸŒŸ About Deploy Hooks
          This workflow uses [Vercel Deploy Hooks](https://vercel.com/docs/deploy-hooks) - simple HTTP endpoints that trigger deployments without requiring authentication. Perfect for open source projects!
          
          EOF 