name: Deploy Frontend

on:
  workflow_call:
    inputs:
      environment:
        required: true
        type: string
      backend_url:
        required: true
        type: string
    outputs:
      deployment_url:
        description: "Frontend deployment URL"
        value: ${{ jobs.deploy.outputs.deployment_url }}

jobs:
  deploy:
    runs-on: ubuntu-latest
    outputs:
      deployment_url: ${{ steps.validate.outputs.deployment_url }}
    
    steps:
      - name: ğŸ›’ Checkout Repository
        uses: actions/checkout@v4
      
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      
      - name: ğŸ“¥ Install Frontend Dependencies
        run: |
          cd frontend
          npm ci
      
      - name: ğŸ”§ Configure Backend Integration
        run: |
          echo "ğŸ”— Backend URL: ${{ inputs.backend_url }}"
          if [[ ! "${{ inputs.backend_url }}" =~ ^https?:// ]]; then
            echo "âŒ Invalid backend URL format"
            exit 1
          fi
      
      - name: ğŸ—ï¸ Build Frontend
        run: |
          cd frontend
          npm run build
        env:
          VITE_API_BASE_URL: ${{ inputs.backend_url }}
      
      - name: ğŸ§ª Run Frontend Tests
        run: |
          cd frontend
          npm test 2>/dev/null || echo "âš ï¸ Tests not configured or failed"
      
      - name: ğŸš€ Deploy to Vercel
        id: deploy
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_FRONTEND_PROJECT_ID }}
          working-directory: ./frontend
          vercel-args: '--prebuilt --build-env VITE_API_BASE_URL=${{ inputs.backend_url }}'
      
      - name: âœ… Validate Frontend Deployment
        id: validate
        run: |
          FRONTEND_URL="${{ steps.deploy.outputs.preview-url }}"
          echo "ğŸ” Testing frontend at: $FRONTEND_URL"
          
          # Test if frontend is accessible
          for i in {1..3}; do
            echo "ğŸ“± Frontend accessibility test $i/3..."
            if curl -f "$FRONTEND_URL" -m 10 >/dev/null 2>&1; then
              echo "âœ… Frontend is accessible!"
              break
            fi
            
            if [ $i -eq 3 ]; then
              echo "âŒ Frontend accessibility test failed"
              exit 1
            fi
            
            echo "â³ Waiting 5 seconds before retry..."
            sleep 5
          done
          
          echo "deployment_url=$FRONTEND_URL" >> $GITHUB_OUTPUT
      
      - name: ğŸ“Š Deployment Summary
        run: |
          echo "ğŸŒŸ Frontend Deployment Complete!"
          echo "ğŸ“ URL: ${{ steps.deploy.outputs.preview-url }}"
          echo "ğŸ”Œ Backend: ${{ inputs.backend_url }}"
          echo "âœ… Ready for integration testing" 